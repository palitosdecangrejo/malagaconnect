<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Málaga Connect - Pro Dashboard v4</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #00A676; /* Verde Connect */
            --primary-dark: #008c63;
            --secondary: #2C3E50;
            --bg-light: #f3f4f6;
            --white: #ffffff;
            --accent-red: #E74C3C;
            --text-main: #333;
            
            /* Niveles */
            --lvl-plastic: #95a5a6;
            --lvl-hybrid: #27ae60;
            --lvl-electric: #f1c40f;
            --lvl-hydrogen: #3498db;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--secondary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .logo {
            font-size: 1.4rem; font-weight: 700; color: var(--primary);
            margin-bottom: 40px; display: flex; align-items: center; gap: 10px;
        }
        .logo span { color: white; }

        .nav-item {
            padding: 12px 15px; margin-bottom: 8px; border-radius: 10px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px;
            color: rgba(255,255,255,0.7);
        }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { border-left: 4px solid var(--primary); }

        /* --- MAIN CONTENT --- */
        .main {
            flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }

        .header { display: flex; justify-content: space-between; align-items: center; }
        
        .points-badge {
            background: white; padding: 8px 16px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px;
            color: var(--primary-dark);
        }

        /* --- VISTA PLANIFICADOR --- */
        .planner-layout {
            display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%;
        }
        
        .search-box {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content;
        }
        
        .input-row { position: relative; margin-bottom: 15px; }
        .input-row i { position: absolute; left: 15px; top: 14px; color: #999; }
        .input-row input {
            width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 0.95rem; box-sizing: border-box;
            background: #f9f9f9; transition: 0.3s;
        }
        .input-row input:focus { border-color: var(--primary); background: white; outline: none; }

        /* Mapa Real */
        #map-planner {
            height: 600px; width: 100%; border-radius: 15px; z-index: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Resultados */
        .result-card {
            background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .result-card.smart { border-color: var(--primary); background: #f0fdf4; }
        
        .badges-row { display: flex; gap: 5px; margin: 8px 0; flex-wrap: wrap; }
        .badge {
            padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; color: white; font-weight: 600;
        }

        /* --- VISTA GEMELO DIGITAL --- */
        #map-twin {
            height: 70vh; width: 100%; border-radius: 15px; z-index: 1;
        }
        .twin-overlay {
            position: absolute; top: 20px; right: 20px; width: 250px;
            background: rgba(44, 62, 80, 0.9); color: white; padding: 15px;
            border-radius: 10px; z-index: 1000; backdrop-filter: blur(5px);
        }

        /* --- VISTA NIVELES --- */
        .levels-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .lvl-box {
            background: white; padding: 20px; border-radius: 15px; text-align: center;
            opacity: 0.5; transition: 0.3s; border: 2px solid transparent;
        }
        .lvl-box.current { opacity: 1; border-color: var(--primary); transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Dashboard Hero */
        .hero-card {
            background: linear-gradient(135deg, var(--secondary), #1a252f); color: white;
            padding: 30px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between;
        }

        /* Utilidades */
        .hidden { display: none !important; }
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px; width: 100%;
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn:hover { background: var(--primary-dark); }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-leaf"></i> <span>Málaga Connect</span></div>
        <div class="nav-item active" onclick="showView('dash')"><i class="fas fa-tachometer-alt"></i> Panel Principal</div>
        <div class="nav-item" onclick="showView('plan')"><i class="fas fa-map-signs"></i> Planificador Smart</div>
        <div class="nav-item" onclick="showView('twin')"><i class="fas fa-city"></i> Gemelo Digital</div>
        <div class="nav-item" onclick="showView('levels')"><i class="fas fa-medal"></i> Mis Niveles</div>
    </div>

    <div class="main">
        
        <div class="header">
            <div>
                <h1 style="margin:0;">Dashboard Personal</h1>
                <p style="margin:5px 0 0; color:#777;">Bienvenido de nuevo, Usuario.</p>
            </div>
            <div class="points-badge">
                <i class="fas fa-coins" style="color: var(--primary); font-size: 1.2rem;"></i>
                <span id="headerPoints">450</span> pts
            </div>
        </div>

        <div id="view-dash">
            <div class="hero-card">
                <div>
                    <span style="background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;">ESTADO ACTUAL</span>
                    <h1 id="dashLevelName" style="font-size: 3rem; margin: 10px 0;">HÍBRIDO</h1>
                    <p id="dashLevelNext" style="opacity: 0.8;">Siguiente: Eléctrico (Faltan 50 pts)</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 4rem; font-weight: bold; color: var(--primary);">450</div>
                    <div style="font-size: 1rem;">Puntos Totales</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="result-card" style="text-align: center; padding: 30px;">
                    <i class="fas fa-chart-line" style="font-size: 2rem; color: #3498db; margin-bottom: 10px;"></i>
                    <h2>12</h2>
                    <p>Viajes Sostenibles</p>
                </div>
                <div class="result-card" style="text-align: center; padding: 30px;">
                    <i class="fas fa-leaf" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                    <h2>8.5 kg</h2>
                    <p>CO2 Ahorrado</p>
                </div>
                <div class="result-card" style="text-align: center; padding: 30px;">
                    <i class="fas fa-wallet" style="font-size: 2rem; color: #f1c40f; margin-bottom: 10px;"></i>
                    <h2>24.50€</h2>
                    <p>Ahorro Estimado</p>
                </div>
            </div>
        </div>

        <div id="view-plan" class="hidden">
            <div class="planner-layout">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="search-box">
                        <h3><i class="fas fa-search-location"></i> Buscar Ruta</h3>
                        <div class="input-row">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i>
                            <input type="text" id="originInput" placeholder="Origen (ej: Teatinos, Centro...)" value="Teatinos">
                        </div>
                        <div class="input-row">
                            <i class="fas fa-flag-checkered" style="color: var(--accent-red);"></i>
                            <input type="text" id="destInput" placeholder="Destino (ej: PTA, Aeropuerto...)">
                        </div>
                        <button class="btn" onclick="calculateRoute()">Buscar Rutas</button>
                    </div>

                    <div id="routeResults" class="hidden">
                        <p style="font-weight: bold; color: #555;">Mejores opciones encontradas:</p>
                        
                        <div class="result-card smart" onclick="selectTrip('smart')">
                            <div style="display: flex; justify-content: space-between;">
                                <strong style="color: var(--primary);">SMART TIMING (Salida Flexible)</strong>
                                <span style="font-weight: bold; color: var(--primary);">GRATIS</span>
                            </div>
                            <div class="badges-row" id="smartBadges">
                                </div>
                            <small id="smartDesc">Viajas 20 min antes de hora punta.</small>
                            <div style="margin-top: 8px; color: var(--primary-dark); font-weight: bold;">+50 Monedas Verdes</div>
                        </div>

                        <div class="result-card" onclick="selectTrip('normal')">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>Hora Punta (Ahora)</strong>
                                <span>2.40€</span>
                            </div>
                            <div class="badges-row" id="normalBadges">
                                </div>
                            <small style="color: var(--accent-red); font-weight: bold;">
                                <i class="fas fa-exclamation-triangle"></i> Alta ocupación (117%)
                            </small>
                        </div>
                    </div>
                </div>

                <div id="map-planner"></div>
            </div>
        </div>

        <div id="view-twin" class="hidden">
            <div style="position: relative; height: 100%;">
                <div id="map-twin"></div>
                
                <div class="twin-overlay">
                    <h3 style="margin-top: 0; color: var(--primary);">Málaga Digital Twin</h3>
                    <div style="margin-bottom: 10px;">
                        <span class="blink" style="color: #e74c3c; margin-right: 5px;">●</span> Tráfico Elevado (A-7)
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="color: #2ecc71; margin-right: 5px;">●</span> E-Bikes Disponibles: 85%
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.2);">
                    <small>Datos en tiempo real agregados de sensores IoT y validaciones de usuarios.</small>
                </div>
            </div>
        </div>

        <div id="view-levels" class="hidden">
            <div class="hero-card" style="background: linear-gradient(to right, #00A676, #008c63);">
                <div style="width: 100%;">
                    <h2>Tu Progreso</h2>
                    <p>Consigue monedas verdes para desbloquear descuentos.</p>
                    <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; margin-top: 15px; position: relative;">
                        <div id="levelProgressBar" style="background: #f1c40f; height: 100%; width: 45%; border-radius: 10px; transition: width 1s;"></div>
                    </div>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.9rem;" id="pointsTextBar">450 / 500 pts</div>
                </div>
            </div>

            <div class="levels-grid">
                <div class="lvl-box" id="lvl-PLÁSTICO">
                    <i class="fas fa-recycle" style="font-size: 2rem; color: #95a5a6;"></i>
                    <h3>PLÁSTICO</h3>
                    <small>0 - 499</small>
                </div>
                <div class="lvl-box" id="lvl-HÍBRIDO">
                    <i class="fas fa-leaf" style="font-size: 2rem; color: #27ae60;"></i>
                    <h3>HÍBRIDO</h3>
                    <small>500 - 999</small>
                </div>
                <div class="lvl-box" id="lvl-ELÉCTRICO">
                    <i class="fas fa-bolt" style="font-size: 2rem; color: #f1c40f;"></i>
                    <h3>ELÉCTRICO</h3>
                    <small>1000 - 2499</small>
                </div>
                <div class="lvl-box" id="lvl-HIDRÓGENO">
                    <i class="fas fa-water" style="font-size: 2rem; color: #3498db;"></i>
                    <h3>HIDRÓGENO</h3>
                    <small>2500+</small>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURACIÓN GLOBAL ---
        let userPoints = 450;
        let mapP, mapT; // Variables para mapas
        let routeLayer; // Capa para dibujar rutas

        // Coordenadas "Hardcoded" para la simulación inteligente
        const locations = {
            "centro": [36.7213, -4.4214],
            "calle larios": [36.7213, -4.4214],
            "teatinos": [36.7176, -4.4750],
            "universidad": [36.7176, -4.4750],
            "pta": [36.7366, -4.5539],
            "parque tecnologico": [36.7366, -4.5539],
            "aeropuerto": [36.6749, -4.4991],
            "torremolinos": [36.6243, -4.4996],
            "marbella": [36.5101, -4.8824],
            "rincon": [36.7158, -4.2773]
        };

        // Niveles
        const levels = [
            { name: "PLÁSTICO", min: 0, color: "#95a5a6" },
            { name: "HÍBRIDO", min: 500, color: "#27ae60" },
            { name: "ELÉCTRICO", min: 1000, color: "#f1c40f" },
            { name: "HIDRÓGENO", min: 2500, color: "#3498db" }
        ];

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            initMaps();
            updateUI();
        };

        function initMaps() {
            // Mapa Planificador (Centrado en Málaga)
            mapP = L.map('map-planner').setView([36.7213, -4.4214], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(mapP);

            // Mapa Gemelo Digital (Estilo Oscuro simulado con filtro CSS si quisieramos, pero usaremos el standard limpio)
            mapT = L.map('map-twin').setView([36.7213, -4.4214], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO'
            }).addTo(mapT);

            // Simular Datos Gemelo Digital (Círculos de calor)
            L.circle([36.72, -4.42], {color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 500}).addTo(mapT); // Centro saturado
            L.circle([36.718, -4.48], {color: 'green', fillColor: '#2ecc71', fillOpacity: 0.5, radius: 400}).addTo(mapT); // Teatinos libre
            L.circle([36.675, -4.499], {color: 'orange', fillColor: '#f39c12', fillOpacity: 0.5, radius: 600}).addTo(mapT); // Aeropuerto
        }

        // --- NAVEGACIÓN ---
        function showView(viewId) {
            // Ocultar vistas
            ['dash', 'plan', 'twin', 'levels'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Mostrar vista
            document.getElementById('view-'+viewId).classList.remove('hidden');
            
            // Highlight menú (simple)
            const menuIdx = {'dash':0, 'plan':1, 'twin':2, 'levels':3};
            document.querySelectorAll('.nav-item')[menuIdx[viewId]].classList.add('active');

            // TRUCO IMPORTANTE: Recalcular tamaño de mapa al mostrar (si no se ve gris)
            setTimeout(() => {
                if(viewId === 'plan') mapP.invalidateSize();
                if(viewId === 'twin') mapT.invalidateSize();
            }, 100);
        }

        // --- LÓGICA PLANIFICADOR INTELIGENTE ---
        function calculateRoute() {
            // 1. Obtener texto usuario
            const originTxt = document.getElementById('originInput').value.toLowerCase();
            const destTxt = document.getElementById('destInput').value.toLowerCase();

            // 2. Buscar coordenadas (Simulación de Geocoding)
            // Si no encuentra la ciudad en mi lista, usa un punto aleatorio cerca de Málaga
            let p1 = findCoord(originTxt) || [36.72 + (Math.random()*0.05), -4.42 - (Math.random()*0.05)];
            let p2 = findCoord(destTxt) || [36.72 - (Math.random()*0.05), -4.42 + (Math.random()*0.05)];

            // 3. Limpiar mapa anterior
            if(routeLayer) mapP.removeLayer(routeLayer);
            document.getElementById('routeResults').classList.add('hidden');

            // 4. Simular carga
            const btn = document.querySelector('#view-plan .btn');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando Tráfico...';

            setTimeout(() => {
                btn.innerText = originalText;
                
                // 5. Dibujar ruta (Línea simple)
                routeLayer = L.polyline([p1, p2], {color: 'blue', weight: 4, opacity: 0.7}).addTo(mapP);
                // Añadir marcadores
                L.marker(p1).addTo(mapP).bindPopup("Origen: " + document.getElementById('originInput').value).openPopup();
                L.marker(p2).addTo(mapP).bindPopup("Destino: " + document.getElementById('destInput').value);
                
                // Ajustar zoom para ver toda la ruta
                mapP.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});

                // 6. Generar Tarjetas de Transporte Dinámicas según distancia/destino
                generateDynamicTransport(destTxt);

                document.getElementById('routeResults').classList.remove('hidden');
            }, 1000);
        }

        function findCoord(text) {
            for (let key in locations) {
                if (text.includes(key)) return locations[key];
            }
            return null;
        }

        function generateDynamicTransport(destText) {
            const smartContainer = document.getElementById('smartBadges');
            const normalContainer = document.getElementById('normalBadges');
            smartContainer.innerHTML = '';
            normalContainer.innerHTML = '';

            // Lógica "Fake" pero realista:
            // Si vamos al PTA -> Bus o Metro. Si vamos a Torremolinos -> Tren.
            
            let badgesSmart = [];
            let badgesNormal = [];

            if(destText.includes('torremolinos') || destText.includes('aeropuerto') || destText.includes('centro')) {
                // Ruta de Cercanías
                badgesSmart = [
                    {icon: 'bicycle', color: '#00A676', text: 'E-Bike'},
                    {icon: 'train', color: '#8e44ad', text: 'Tren C-1'}
                ];
                badgesNormal = [
                    {icon: 'car', color: '#7f8c8d', text: 'Uber/Taxi'},
                    {icon: 'train', color: '#8e44ad', text: 'Tren C-1'}
                ];
            } else if (destText.includes('pta') || destText.includes('teatinos')) {
                // Ruta Metro/Bus
                badgesSmart = [
                    {icon: 'walking', color: '#95a5a6', text: '5 min'},
                    {icon: 'bus', color: '#2980b9', text: 'Bus 25 Exprés'}
                ];
                badgesNormal = [
                    {icon: 'car', color: '#e74c3c', text: 'Coche'},
                    {icon: 'parking', color: '#c0392b', text: 'Parking Lleno'}
                ];
            } else {
                // Genérico
                badgesSmart = [
                    {icon: 'bicycle', color: '#00A676', text: 'Green Wheel'},
                    {icon: 'subway', color: '#e74c3c', text: 'Metro L1'}
                ];
                badgesNormal = [
                    {icon: 'bus', color: '#2980b9', text: 'Bus Regular'},
                    {icon: 'subway', color: '#e74c3c', text: 'Metro L1'}
                ];
            }

            // Renderizar HTML
            renderBadges(badgesSmart, smartContainer);
            renderBadges(badgesNormal, normalContainer);
        }

        function renderBadges(list, container) {
            list.forEach(item => {
                const span = document.createElement('span');
                span.className = 'badge';
                span.style.backgroundColor = item.color;
                span.innerHTML = `<i class="fas fa-${item.icon}"></i> ${item.text}`;
                container.appendChild(span);
            });
        }

        // --- GAMIFICACIÓN ---
        function selectTrip(type) {
            if(type === 'smart') {
                userPoints += 50;
                alert("¡Ruta Smart Confirmada! \n\nHas ganado +50 Monedas Verdes.");
            } else {
                alert("Ruta Estándar seleccionada.");
            }
            updateUI();
        }

        function updateUI() {
            // 1. Detectar Nivel
            let currentLvl = levels[0];
            let nextLvl = levels[1];

            for(let i=0; i<levels.length; i++) {
                if(userPoints >= levels[i].min) {
                    currentLvl = levels[i];
                    nextLvl = levels[i+1] || null;
                }
            }

            // 2. Actualizar Textos
            document.getElementById('headerPoints').innerText = userPoints;
            document.getElementById('dashLevelName').innerText = currentLvl.name;
            document.getElementById('dashLevelName').style.color = currentLvl.color;

            // 3. Actualizar Barra
            if(nextLvl) {
                const range = nextLvl.min - currentLvl.min;
                const progress = userPoints - currentLvl.min;
                const pct = (progress / range) * 100;
                
                document.getElementById('levelProgressBar').style.width = pct + "%";
                document.getElementById('levelProgressBar').style.background = nextLvl.color;
                document.getElementById('dashLevelNext').innerText = `Siguiente: ${nextLvl.name} (Faltan ${nextLvl.min - userPoints} pts)`;
                document.getElementById('pointsTextBar').innerText = `${userPoints} / ${nextLvl.min} pts`;
            } else {
                document.getElementById('levelProgressBar').style.width = "100%";
                document.getElementById('dashLevelNext').innerText = "¡Nivel Máximo Alcanzado!";
            }

            // 4. Highlight tarjeta nivel
            document.querySelectorAll('.lvl-box').forEach(b => b.classList.remove('current'));
            const activeBox = document.getElementById('lvl-'+currentLvl.name);
            if(activeBox) {
                activeBox.classList.add('current');
                activeBox.style.borderColor = currentLvl.color;
            }
        }
    </script>
</body>
</html>